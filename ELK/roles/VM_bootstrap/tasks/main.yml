---
- set_fact:
    number_of_nodes: "{{ non_production_nodes}}"

- set_fact:
    number_of_nodes: "{{ production_nodes}}"
  when: ( production == true )

- hosts: localhost
  connection: local
  gather_facts: False

  - name: Provision instances.
    ec2:
      key_name: "{{ ec2['key_name'] }}"
      instance_type: "{{ ec2['instance_type'] }}"
      image: "{{ ec2['image'] }}"
      wait: yes
      count: "{{ number_of_nodes }}"
      wait: true
      vpc_subnet_id: "{{ ec2['vpc_subnet_id'] }}"
      assign_public_ip: yes
      region: "{{ ec2['region'] }}"
      group_id: "{{ ec2['group_id'] }}"
    register: ec2

  - name: Add all instance public IPs to host group
    add_host: hostname={{ item.public_ip }} groups=ec2hosts
    loop: "{{ ec2.instances }}"

  - name: Add instances to cluster "linux_server"
    add_host: hostname={{ item.public_ip }} groups=linux_server
    loop: "{{ ec2.instances }}"
    when: item.ami_launch_index == "0"

  - name: Add instances to cluster "monitoring_1"
    add_host: hostname={{ item.public_ip }} groups=monitoring_1
    loop: "{{ ec2.instances }}"
    when: (item.ami_launch_index == "1" or item.ami_launch_index == "3" )

  - name: Add instances to cluster "monitoring_2"
    add_host: hostname={{ item.public_ip }} groups=monitoring_2
    loop: "{{ ec2.instances }}"
    when: (item.ami_launch_index == "2" or item.ami_launch_index == "4" )

  - pause: minutes=1
